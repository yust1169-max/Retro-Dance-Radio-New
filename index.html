<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Retro Dance Radio — Включай энергию!</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            background-color: #0a0a0a; 
            font-family: 'Inter', sans-serif; 
            color: white; 
            margin: 0; 
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .glass-bordeaux { 
            background: rgba(45, 0, 10, 0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .marquee-container { overflow: hidden; white-space: nowrap; width: 100%; position: relative; }
        .marquee-text { display: inline-block; animation: marquee 12s linear infinite; padding-right: 60px; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        /* Кастомный скролл для истории, чтобы помещалось много песен */
        .history-container::-webkit-scrollbar { width: 4px; }
        .history-container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_URL = "https://radio.retrodanceradio.com/api/nowplaying/retro_dance_radio";
        const STREAMS = {
            high: "https://radio.retrodanceradio.com/listen/retro_dance_radio/radio.mp3",
            low: "https://radio.retrodanceradio.com/listen/retro_dance_radio/radio32.AAC"
        };

        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name, className]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        function App() {
            const [isPlaying, setIsPlaying] = useState(false);
            const [quality, setQuality] = useState('high');
            const [activeTab, setActiveTab] = useState('player');
            const [meta, setMeta] = useState({ song: "Загрузка...", artist: "Retro Radio", image: "https://i.postimg.cc/28VKXjCx/logo.png" });
            const [history, setHistory] = useState([]);
            const audioRef = useRef(null);

            const fetchData = async () => {
                try {
                    const res = await fetch(API_URL);
                    const data = await res.json();
                    if (data) {
                        setMeta({
                            song: data.now_playing.song.title || "Эфир",
                            artist: data.now_playing.song.artist || "Retro Dance Radio",
                            image: data.now_playing.song.art
                        });
                        // Берем до 20 последних треков
                        if (data.song_history) setHistory(data.song_history.slice(0, 20));
                    }
                } catch (e) { console.error("Ошибка API"); }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 15000);
                return () => clearInterval(interval);
            }, []);

            const togglePlay = () => {
                if (!isPlaying) {
                    audioRef.current.src = STREAMS[quality];
                    audioRef.current.play().catch(console.error);
                    setIsPlaying(true);
                } else {
                    audioRef.current.pause();
                    audioRef.current.src = "";
                    setIsPlaying(false);
                }
            };

            const changeQuality = (q) => {
                setQuality(q);
                if (isPlaying) {
                    audioRef.current.pause();
                    audioRef.current.src = STREAMS[q];
                    audioRef.current.play();
                }
            };

            return (
                <div className="w-full max-w-sm px-4">
                    <audio ref={audioRef} crossOrigin="anonymous" />
                    
                    <div className="glass-bordeaux rounded-[50px] p-6 shadow-2xl flex flex-col items-center min-h-[620px]">
                        
                        {/* Табы */}
                        <div className="flex gap-2 mb-8 bg-black/30 p-1.5 rounded-full w-full border border-white/5">
                            <button onClick={() => setActiveTab('player')} 
                                className={`flex-1 py-2 rounded-full text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'player' ? 'bg-white/10 text-white' : 'text-white/20'}`}>
                                Плеер
                            </button>
                            <button onClick={() => setActiveTab('history')} 
                                className={`flex-1 py-2 rounded-full text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'history' ? 'bg-white/10 text-white' : 'text-white/20'}`}>
                                История
                            </button>
                        </div>

                        {activeTab === 'player' ? (
                            <div className="flex flex-col items-center w-full animate-in fade-in duration-500">
                                {/* Обложка */}
                                <div className="relative mb-8 group">
                                    <img src={meta.image} className={`w-64 h-64 object-cover rounded-[40px] shadow-2xl transition-transform duration-500 ${isPlaying ? 'scale-105' : 'scale-100'}`} alt="Cover" />
                                </div>

                                {/* Название и Артист */}
                                <div className="w-full text-center mb-8 h-20 overflow-hidden">
                                    <div className="marquee-container">
                                        <div className="marquee-text">
                                            <h2 className="text-3xl font-black uppercase italic tracking-tighter">{meta.song}&nbsp;&nbsp;&nbsp;&nbsp;{meta.song}</h2>
                                        </div>
                                    </div>
                                    <p className="text-white/30 font-bold uppercase tracking-[0.2em] text-[10px] mt-2 truncate px-4">{meta.artist}</p>
                                </div>

                                {/* КНОПКА PLAY (ЖЕЛТЕЕТ ПРИ ВКЛЮЧЕНИИ) */}
                                <button 
                                    onClick={togglePlay} 
                                    className={`w-24 h-24 rounded-full flex items-center justify-center transition-all duration-300 shadow-2xl mb-10 active:scale-90
                                        ${isPlaying ? 'bg-yellow-400 text-black shadow-yellow-400/30' : 'bg-white text-black'}`}
                                >
                                    {isPlaying ? <Icon name="pause" size={44} className="fill-current" /> : <Icon name="play" size={44} className="ml-1.5 fill-current" />}
                                </button>

                                {/* Переключатель качества */}
                                <div className="flex gap-2 w-full mt-auto">
                                    <button onClick={() => changeQuality('high')} 
                                        className={`flex-1 py-3 rounded-2xl font-black text-[10px] transition-all border ${quality === 'high' ? 'bg-white text-black border-white' : 'bg-transparent text-white/20 border-white/5'}`}>128K MP3</button>
                                    <button onClick={() => changeQuality('low')} 
                                        className={`flex-1 py-3 rounded-2xl font-black text-[10px] transition-all border ${quality === 'low' ? 'bg-white text-black border-white' : 'bg-transparent text-white/20 border-white/5'}`}>32K AAC</button>
                                </div>
                            </div>
                        ) : (
                            /* ИСТОРИЯ НА 20 ПЕСЕН */
                            <div className="w-full flex flex-col h-[480px] animate-in slide-in-from-right duration-300">
                                <h3 className="text-center font-black uppercase tracking-[0.4em] text-[9px] mb-6 opacity-30">Последние 20 треков</h3>
                                <div className="flex-1 overflow-y-auto history-container pr-1">
                                    {history.length > 0 ? history.map((item, i) => (
                                        <div key={i} className="flex items-center gap-3 mb-3 p-2.5 rounded-2xl bg-white/5 border border-white/5 hover:bg-white/10 transition-colors">
                                            <img src={item.song.art} className="w-10 h-10 rounded-xl object-cover" />
                                            <div className="flex-1 min-w-0">
                                                <p className="text-[11px] font-black uppercase truncate leading-none mb-1.5">{item.song.title}</p>
                                                <p className="text-[9px] font-bold uppercase text-white/30 truncate tracking-wider">{item.song.artist}</p>
                                            </div>
                                            <span className="text-[8px] opacity-20 font-black">
                                                {new Date(item.played_at * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                            </span>
                                        </div>
                                    )) : <p className="text-center text-[10px] opacity-20 mt-10">Загрузка истории...</p>}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <p className="mt-6 text-center text-[8px] font-black uppercase tracking-[1.5em] opacity-10">Retro Dance Radio 2025</p>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>